{
  "log": [
    "HTTP+"
  ],
  "adminInterface": ":4985",
  "interface": ":4984",
  "databases": {
    "db": {
      "bucket": "fleet-prod",
      "username": "fleet-prod",
      "password": "123456",
      "server": "http://couchbase:8091",
      "enable_shared_bucket_access": true,
      "import_docs": "continuous",
      "users": {},
      "sync": "function sync_func(doc,oldDoc){if(!doc._deleted||doc.type||oldDoc){var company_id,type,action,COMPANY='company',USER='user',MISSION='mission',MISSION_STATUS_TYPE='mission_status_type',MISSION_ACTION_TYPE='mission_action_type',TYPES_DRIVER={company:function(doc,oldDoc,params){var companyChannel=makeCompanyChannel(params.company_id);switch(params.action){case CREATING:case UPDATING:checkName(doc,oldDoc)}channel([companyChannel])},user:user,user_settings:function(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);switch(params.action){case UPDATING:case CREATING:var channelUser=makeUserChannel(sync_user);channel([channelUser]),access([sync_user],[channelUser])}},user_current_location:function(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);switch(params.action){case UPDATING:case CREATING:var channelUser=makeUserChannel(sync_user);channel([channelUser]),access([sync_user],[channelUser])}},user_track:function(doc,oldDoc,params){},route:function(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);requireUser(sync_user),doc.archive?channel():channel([makeUserChannel(sync_user)])},mission:function(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);requireUser(sync_user);var date=checkDate(doc,oldDoc),missionChannel=makeMissionChannels(sync_user,date),missionRouteChannel=(route_id=doc.route_id,MISSION+CHANNEL_SEPARATOR+route_id);var route_id;switch(params.action){case CREATING:case UPDATING:checkName(doc,oldDoc),access([sync_user],[missionChannel,missionRouteChannel])}channel([missionChannel,missionRouteChannel])},missions_placeholder:function(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);requireUser(sync_user);var date=checkDate(doc,oldDoc),syncUserChannels=makeMissionChannels(sync_user,date);switch(params.action){case CREATING:case UPDATING:access([sync_user],[syncUserChannels])}channel([syncUserChannels])},mission_action:function(doc,oldDoc,params){},mission_status_type:function(doc,oldDoc,params){var missionStatusTypeChannel=makeMissionStatusTypeChannel(params.company_id);channel([missionStatusTypeChannel])},mission_action_type:function(doc,oldDoc,params){var missionActionTypeChannel=makeMissionActionTypeChannel(params.company_id);channel([missionActionTypeChannel])},meta_info:function(doc,oldDoc,params){switch(params.action){case CREATING:case UPDATING:case DELETING:default:channel(['!'])}}},CREATING='creating',UPDATING='updating',DELETING='deleting',ROLE_SEPARATOR='.',CHANNEL_SEPARATOR=':',params={type:'unknown',action:'unknown',role:'unknown',company_id:'unknown'};params.type=function(doc,oldDoc){var type=oldDoc?oldDoc.type:doc.type;if(!type||!TYPES_DRIVER[type])throw{forbidden:'Unknown document type'};if(oldDoc&&doc&&oldDoc.type!==doc.type&&!0!==doc._deleted)throw{forbidden:'Document type cannot be modify'};return type}(doc,oldDoc),params.action=function(doc,oldDoc){return oldDoc?doc._deleted?DELETING:UPDATING:CREATING}(doc,oldDoc),params.company_id=function(doc,oldDoc,type){return'company'===type?oldDoc?oldDoc._id:doc._id:'meta_info'===type?'mapotempo':oldDoc?oldDoc.company_id:doc.company_id}(doc,oldDoc,params.type),params.role=(company_id=params.company_id,type=params.type,action=params.action,company_id+ROLE_SEPARATOR+type+ROLE_SEPARATOR+action),requireRole(params.role),function(doc,oldDoc,type){if('company'===type||'meta_info'===type)return;if(!(oldDoc?oldDoc.company_id:doc.company_id))throw{forbidden:'Document must have a company_id'};if(doc&&oldDoc&&doc.company_id&&oldDoc.company_id&&doc.company_id!==oldDoc.company_id)throw{forbidden:'Document ID cannot be modify'}}(doc,oldDoc,params.type),TYPES_DRIVER[params.type](doc,oldDoc,params)}function user(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);doc.channels=[];var channelUser=makeUserChannel(sync_user);doc.channels.push(channelUser);var companyChannel=makeCompanyChannel(params.company_id);doc.channels.push(companyChannel);var missionStatusTypeChannel=makeMissionStatusTypeChannel(params.company_id);doc.channels.push(missionStatusTypeChannel);var missionActionTypeChannel=makeMissionActionTypeChannel(params.company_id);switch(doc.channels.push(missionActionTypeChannel),params.action){case CREATING:case UPDATING:channel([channelUser]);var userRoles=function(doc,oldDoc,company_id){var roles=oldDoc?oldDoc.roles:doc.roles,res=[];if(roles&&Array.isArray(roles))for(var i=0;i<roles.length;i++)res[i]='role:'+company_id+ROLE_SEPARATOR+roles[i];else res[0]='role:default';return res}(doc,oldDoc,params.company_id);role([sync_user],userRoles),access([sync_user],[channelUser]),access([sync_user],[companyChannel]),access([sync_user],[missionStatusTypeChannel]),access([sync_user],[missionActionTypeChannel]),access([sync_user],['!'])}}function checkSyncUser(doc,oldDoc){var sync_user=oldDoc?oldDoc.sync_user:doc.sync_user;if(!sync_user)throw{forbidden:'Document must have user'};if(Array.isArray(user))throw{forbidden:'It can only have one user'};return sync_user}function checkDate(doc,oldDoc){var date=doc?doc.date:oldDoc.date;if(!(date=!date&&oldDoc?oldDoc.date:date))throw{forbidden:'Document must have a date'};if(isNaN(Date.parse(date)))throw{forbidden:'Document must have a date ISO8601 valid format'};return date}function checkName(doc,oldDoc){if(!doc.name||'string'!=typeof doc.name)throw{forbidden:'Document must have a name'}}function makeCompanyChannel(company_id){return COMPANY+CHANNEL_SEPARATOR+company_id}function makeMissionStatusTypeChannel(company_id){return MISSION_STATUS_TYPE+CHANNEL_SEPARATOR+company_id}function makeMissionActionTypeChannel(company_id){return MISSION_ACTION_TYPE+CHANNEL_SEPARATOR+company_id}function makeUserChannel(user){return USER+CHANNEL_SEPARATOR+user}function makeMissionChannels(sync_user,date){var timestamp=Date.parse(date);if(isNaN(timestamp))throw{forbidden:'Document must have a date ISO8601 valid format'};var newDate=new Date(timestamp),channel_date=''+newDate.getFullYear()+('0'+(newDate.getMonth()+1)).slice(-2)+('0'+newDate.getDate()).slice(-2);return MISSION+CHANNEL_SEPARATOR+sync_user+CHANNEL_SEPARATOR+channel_date}}",
      "event_handlers": {
        "document_changed": [
          {
            "handler": "webhook",
            "url": "http://wrapper/webhook/mission_action_changes",
            "filter": "function(doc) { if (doc.type == 'mission_action') { return true; } return false; }"
          }
        ]
      }
    }
  }
}
