{
  "log": [
    "HTTP+"
  ],
  "adminInterface": ":4985",
  "interface": ":4984",
  "databases": {
    "db": {
      "bucket": "fleet-prod",
      "username": "fleet-prod",
      "password": "123456",
      "server": "http://couchbaseserver:8091",
      "enable_shared_bucket_access": true,
      "import_docs": "continuous",
      "users": {},
      "sync": "function sync_func(doc,oldDoc){function company(doc,oldDoc,params){var companyChannel=makeCompanyChannel(params.company_id);switch(params.action){case CREATING:case UPDATING:checkName(doc,oldDoc);break;case DELETING:}channel([companyChannel])}function user(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);doc.channels=[];var channelUser=makeUserChannel(sync_user);doc.channels.push(channelUser);var companyChannel=makeCompanyChannel(params.company_id);doc.channels.push(companyChannel);var missionStatusTypeChannel=makeMissionStatusTypeChannel(params.company_id);doc.channels.push(missionStatusTypeChannel);var missionActionTypeChannel=makeMissionActionTypeChannel(params.company_id);switch(doc.channels.push(missionActionTypeChannel),params.action){case CREATING:case UPDATING:channel([channelUser]);var userRoles=makeUserRoles(doc,oldDoc,params.company_id);role([sync_user],userRoles),access([sync_user],[channelUser]),access([sync_user],[companyChannel]),access([sync_user],[missionStatusTypeChannel]),access([sync_user],[missionActionTypeChannel]),access([sync_user],['!']);break;case DELETING:}}function user_current_location(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);switch(params.action){case UPDATING:case CREATING:var channelUser=makeUserChannel(sync_user);channel([channelUser]),access([sync_user],[channelUser]);case DELETING:}}function user_settings(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);switch(params.action){case UPDATING:case CREATING:var channelUser=makeUserChannel(sync_user);channel([channelUser]),access([sync_user],[channelUser]);case DELETING:}}function user_track(doc,oldDoc,params){}function mission(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);requireUser(sync_user);var date=checkDate(doc,oldDoc),syncUserChannels=makeMissionChannels(sync_user,date);switch(params.action){case CREATING:case UPDATING:checkName(doc,oldDoc),access([sync_user],[syncUserChannels]);break;case DELETING:}channel([syncUserChannels])}function missions_placeholder(doc,oldDoc,params){var sync_user=checkSyncUser(doc,oldDoc);requireUser(sync_user);var date=checkDate(doc,oldDoc),syncUserChannels=makeMissionChannels(sync_user,date);switch(params.action){case CREATING:case UPDATING:access([sync_user],[syncUserChannels]);break;case DELETING:}channel([syncUserChannels])}function mission_action(doc,oldDoc,params){}function mission_status_type(doc,oldDoc,params){var missionStatusTypeChannel=makeMissionStatusTypeChannel(params.company_id);channel([missionStatusTypeChannel])}function mission_action_type(doc,oldDoc,params){var missionActionTypeChannel=makeMissionActionTypeChannel(params.company_id);channel([missionActionTypeChannel])}function meta_info(doc,oldDoc,params){switch(params.action){case CREATING:case UPDATING:case DELETING:default:channel(['!'])}}function checkSyncUser(doc,oldDoc){var sync_user=oldDoc?oldDoc.sync_user:doc.sync_user;if(!sync_user)throw{forbidden:'Document must have user'};if(Array.isArray(user))throw{forbidden:'It can only have one user'};return sync_user}function checkDate(doc,oldDoc){var date=doc?doc.date:oldDoc.date;if(date=!date&&oldDoc?oldDoc.date:date,!date)throw{forbidden:'Document must have a date'};if(isNaN(Date.parse(date)))throw{forbidden:'Document must have a date ISO8601 valid format'};return date}function checkName(doc,oldDoc){if(!doc.name||'string'!=typeof doc.name)throw{forbidden:'Document must have a name'}}function makeCompanyChannel(company_id){return COMPANY+CHANNEL_SEPARATOR+company_id}function makeMissionStatusTypeChannel(company_id){return MISSION_STATUS_TYPE+CHANNEL_SEPARATOR+company_id}function makeMissionActionTypeChannel(company_id){return MISSION_ACTION_TYPE+CHANNEL_SEPARATOR+company_id}function makeUserChannel(user){return USER+CHANNEL_SEPARATOR+user}function makeMissionChannels(sync_user,date){var timestamp=Date.parse(date);if(isNaN(timestamp))throw{forbidden:'Document must have a date ISO8601 valid format'};var newDate=new Date(timestamp),channel_date=''+newDate.getFullYear()+('0'+(newDate.getMonth()+1)).slice(-2)+('0'+newDate.getDate()).slice(-2),sync_user_channel=MISSION+CHANNEL_SEPARATOR+sync_user+CHANNEL_SEPARATOR+channel_date;return sync_user_channel}function checkAndGetType(doc,oldDoc){var type=oldDoc?oldDoc.type:doc.type;if(!type||!TYPES_DRIVER[type])throw{forbidden:'Unknown document type'};if(oldDoc&&doc&&oldDoc.type!==doc.type&&doc._deleted!==!0)throw{forbidden:'Document type cannot be modify'};return type}function checkAndGetAction(doc,oldDoc){return oldDoc?doc._deleted?DELETING:UPDATING:CREATING}function getCompanyID(doc,oldDoc,type){return'company'===type?oldDoc?oldDoc._id:doc._id:'meta_info'===type?'mapotempo':oldDoc?oldDoc.company_id:doc.company_id}function checkCompanyID(doc,oldDoc,type){if('company'!==type&&'meta_data'!==type){var company_id=oldDoc?oldDoc.company_id:doc.company_id;if(!company_id)throw{forbidden:'Document must have a company_id'};if(doc&&oldDoc&&doc.company_id&&oldDoc.company_id&&doc.company_id!==oldDoc.company_id)throw{forbidden:'Document ID cannot be modify'}}}function getRoleNeed(company_id,type,action){return company_id+ROLE_SEPARATOR+type+ROLE_SEPARATOR+action}function makeUserRoles(doc,oldDoc,company_id){var roles=oldDoc?oldDoc.roles:doc.roles,res=[];if(roles&&Array.isArray(roles))for(var i=0;i<roles.length;i++)res[i]='role:'+company_id+ROLE_SEPARATOR+roles[i];else res[0]='role:default';return res}if(!doc._deleted||doc.type||oldDoc){var COMPANY='company',USER='user',MISSION='mission',MISSION_STATUS_TYPE='mission_status_type',MISSION_ACTION_TYPE='mission_action_type',TYPES_DRIVER={company:company,user:user,user_settings:user_settings,user_current_location:user_current_location,user_track:user_track,mission:mission,missions_placeholder:missions_placeholder,mission_action:mission_action,mission_status_type:mission_status_type,mission_action_type:mission_action_type,meta_info:meta_info},CREATING='creating',UPDATING='updating',DELETING='deleting',ROLE_SEPARATOR='.',CHANNEL_SEPARATOR=':',params={type:'unknown',action:'unknown',role:'unknown',company_id:'unknown'};params.type=checkAndGetType(doc,oldDoc),params.action=checkAndGetAction(doc,oldDoc),params.company_id=getCompanyID(doc,oldDoc,params.type),params.role=getRoleNeed(params.company_id,params.type,params.action),requireRole(params.role),checkCompanyID(doc,oldDoc,params.type),TYPES_DRIVER[params.type](doc,oldDoc,params)}}",
      "event_handlers": {
        "document_changed": [
          {
            "handler": "webhook",
            "url": "http://192.168.1.126:8084/webhook/mission_action_changes",
            "filter": "function(doc) { if (doc.type == 'mission_action') { return true; } return false; }"
          }
        ]
      }
    }
  }
}
